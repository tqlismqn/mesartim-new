---
import { getLangFromUrl, useTranslations, getLocalizedPath, getAvailableLanguages } from '../../i18n/utils';
import type { Lang } from '../../i18n/ui';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const languages = getAvailableLanguages();

const navigation = [
  { key: 'nav.home', href: '' },
  {
    key: 'nav.services',
    href: '#services',
    children: [
      { key: 'nav.accountingServer', href: 'services/accounting-server' },
      { key: 'nav.accountingBox', href: 'services/accounting-box' },
      { key: 'nav.itSupport', href: 'services/it-support' },
      { key: 'nav.projects', href: 'services/projects' },
    ],
  },
  { key: 'nav.about', href: 'about' },
  { key: 'nav.contact', href: 'contact' },
];

const currentPath = Astro.url.pathname;
---

<header
  class="fixed top-0 left-0 right-0 z-50 transition-all duration-300"
  id="main-header"
>
  <div class="container-custom">
    <nav class="flex items-center justify-between h-20">
      <!-- Logo -->
      <a
        href={getLocalizedPath(lang, '')}
        class="flex items-center gap-2 text-xl font-bold text-[var(--color-text)] hover:text-[var(--color-primary)] transition-colors"
        transition:name="logo"
      >
        <svg
          class="w-8 h-8 text-[var(--color-primary)]"
          viewBox="0 0 32 32"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M16 2L2 9L16 16L30 9L16 2Z"
            fill="currentColor"
            opacity="0.9"
          />
          <path
            d="M2 23L16 30L30 23"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path
            d="M2 16L16 23L30 16"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
        <span>Mesartim</span>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden lg:flex items-center gap-8">
        {navigation.map((item) => (
          item.children ? (
            <div class="relative group">
              <button
                class="flex items-center gap-1 text-[var(--color-text-muted)] hover:text-[var(--color-text)] transition-colors font-medium"
              >
                {t(item.key as keyof typeof t)}
                <svg class="w-4 h-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div class="absolute top-full left-0 pt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                <div class="bg-[var(--color-surface)] rounded-xl shadow-lg border border-[var(--color-border)] py-2 min-w-[200px]">
                  {item.children.map((child) => (
                    <a
                      href={getLocalizedPath(lang, child.href)}
                      class="block px-4 py-2 text-[var(--color-text-muted)] hover:text-[var(--color-text)] hover:bg-[var(--color-emerald-50)] transition-colors"
                    >
                      {t(child.key as keyof typeof t)}
                    </a>
                  ))}
                </div>
              </div>
            </div>
          ) : (
            <a
              href={getLocalizedPath(lang, item.href)}
              class:list={[
                'text-[var(--color-text-muted)] hover:text-[var(--color-text)] transition-colors font-medium',
                currentPath === getLocalizedPath(lang, item.href) && 'text-[var(--color-primary)]',
              ]}
            >
              {t(item.key as keyof typeof t)}
            </a>
          )
        ))}
      </div>

      <!-- Right side: Language + CTA -->
      <div class="hidden lg:flex items-center gap-4">
        <!-- Language Switcher -->
        <div class="relative group">
          <button
            class="flex items-center gap-1 px-3 py-2 text-sm text-[var(--color-text-muted)] hover:text-[var(--color-text)] transition-colors uppercase font-medium"
          >
            {lang}
            <svg class="w-4 h-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div class="absolute top-full right-0 pt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
            <div class="bg-[var(--color-surface)] rounded-xl shadow-lg border border-[var(--color-border)] py-2 min-w-[140px]">
              {languages.map(({ code, name }) => (
                <a
                  href={getLocalizedPath(code, currentPath.replace(/^\/(cs|en|ru|uk|de|pl)/, ''))}
                  class:list={[
                    'block px-4 py-2 text-sm transition-colors',
                    code === lang
                      ? 'text-[var(--color-primary)] bg-[var(--color-emerald-50)]'
                      : 'text-[var(--color-text-muted)] hover:text-[var(--color-text)] hover:bg-[var(--color-emerald-50)]',
                  ]}
                >
                  {name}
                </a>
              ))}
            </div>
          </div>
        </div>

        <!-- CTA Button -->
        <a
          href={getLocalizedPath(lang, 'contact')}
          class="btn btn-primary"
        >
          {t('hero.cta')}
        </a>
      </div>

      <!-- Mobile Menu Button -->
      <button
        class="lg:hidden p-2 text-[var(--color-text)] hover:text-[var(--color-primary)] transition-colors"
        id="mobile-menu-button"
        aria-label="Open menu"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </nav>
  </div>

  <!-- Mobile Menu -->
  <div
    class="fixed inset-0 bg-[var(--color-surface)] z-50 lg:hidden translate-x-full transition-transform duration-300"
    id="mobile-menu"
  >
    <div class="container-custom h-full flex flex-col">
      <div class="flex items-center justify-between h-20">
        <a
          href={getLocalizedPath(lang, '')}
          class="flex items-center gap-2 text-xl font-bold"
        >
          <svg
            class="w-8 h-8 text-[var(--color-primary)]"
            viewBox="0 0 32 32"
            fill="none"
          >
            <path d="M16 2L2 9L16 16L30 9L16 2Z" fill="currentColor" opacity="0.9" />
            <path d="M2 23L16 30L30 23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M2 16L16 23L30 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <span>Mesartim</span>
        </a>
        <button
          class="p-2 text-[var(--color-text)] hover:text-[var(--color-primary)] transition-colors"
          id="mobile-menu-close"
          aria-label="Close menu"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <nav class="flex-1 py-8">
        <div class="space-y-4">
          {navigation.map((item) => (
            item.children ? (
              <div class="space-y-2">
                <span class="block text-lg font-medium text-[var(--color-text)]">
                  {t(item.key as keyof typeof t)}
                </span>
                <div class="pl-4 space-y-2">
                  {item.children.map((child) => (
                    <a
                      href={getLocalizedPath(lang, child.href)}
                      class="block text-[var(--color-text-muted)] hover:text-[var(--color-primary)] transition-colors"
                    >
                      {t(child.key as keyof typeof t)}
                    </a>
                  ))}
                </div>
              </div>
            ) : (
              <a
                href={getLocalizedPath(lang, item.href)}
                class="block text-lg font-medium text-[var(--color-text)] hover:text-[var(--color-primary)] transition-colors"
              >
                {t(item.key as keyof typeof t)}
              </a>
            )
          ))}
        </div>

        <!-- Mobile Language Switcher -->
        <div class="mt-8 pt-8 border-t border-[var(--color-border)]">
          <p class="text-sm text-[var(--color-text-muted)] mb-4">Language</p>
          <div class="flex flex-wrap gap-2">
            {languages.map(({ code, name }) => (
              <a
                href={getLocalizedPath(code, currentPath.replace(/^\/(cs|en|ru|uk|de|pl)/, ''))}
                class:list={[
                  'px-3 py-1.5 rounded-lg text-sm transition-colors',
                  code === lang
                    ? 'bg-[var(--color-primary)] text-white'
                    : 'bg-[var(--color-emerald-50)] text-[var(--color-text)] hover:bg-[var(--color-emerald-100)]',
                ]}
              >
                {name}
              </a>
            ))}
          </div>
        </div>
      </nav>

      <div class="py-8">
        <a
          href={getLocalizedPath(lang, 'contact')}
          class="btn btn-primary w-full justify-center"
        >
          {t('hero.cta')}
        </a>
      </div>
    </div>
  </div>
</header>

<script>
  // Header scroll effect
  const header = document.getElementById('main-header');
  let lastScrollY = 0;

  function updateHeader() {
    const scrollY = window.scrollY;

    if (scrollY > 50) {
      header?.classList.add('glass', 'shadow-sm');
    } else {
      header?.classList.remove('glass', 'shadow-sm');
    }

    lastScrollY = scrollY;
  }

  window.addEventListener('scroll', updateHeader, { passive: true });
  updateHeader();

  // Mobile menu
  const mobileMenuButton = document.getElementById('mobile-menu-button');
  const mobileMenuClose = document.getElementById('mobile-menu-close');
  const mobileMenu = document.getElementById('mobile-menu');

  mobileMenuButton?.addEventListener('click', () => {
    mobileMenu?.classList.remove('translate-x-full');
    document.body.style.overflow = 'hidden';
  });

  mobileMenuClose?.addEventListener('click', () => {
    mobileMenu?.classList.add('translate-x-full');
    document.body.style.overflow = '';
  });

  // Close menu on link click
  mobileMenu?.querySelectorAll('a').forEach((link) => {
    link.addEventListener('click', () => {
      mobileMenu?.classList.add('translate-x-full');
      document.body.style.overflow = '';
    });
  });

  // Re-run on page navigation (View Transitions)
  document.addEventListener('astro:page-load', () => {
    updateHeader();
  });
</script>
